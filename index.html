
<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="./Assets/Image/Logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="سیستم مدیریت برنامه های تمرینی و تغذیه ورزشکاران" />
    <meta name="theme-color" content="#7c3aed" />
    <link rel="manifest" href="./Manifest.json" />
    <title>مدیریت برنامه</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <!-- Favicon settings -->
    <link rel="apple-touch-icon" href="./Assets/Image/Logo.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <!-- جلوگیری از کش مرورگر با افزودن پارامتر زمان -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <div id="root"></div>
    <!-- Service Worker registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          // ثبت سرویس ورکر با پارامتر زمان برای جلوگیری از کش
          const swUrl = './Service-Worker.js?v=' + new Date().getTime();
          
          // Register the service worker from root path with improved error handling
          navigator.serviceWorker.register(swUrl)
            .then(function(registration) {
              // Registration was successful
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
              
              // نگهداری نسخه فعلی برنامه
              let currentVersion = '';
              
              // خواندن نسخه فعلی از مانیفست
              fetch('./Manifest.json?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                  currentVersion = data.version || '';
                  console.log('Current app version:', currentVersion);
                  // ذخیره نسخه در localStorage
                  localStorage.setItem('app_version', currentVersion);
                })
                .catch(err => {
                  console.error('Failed to read manifest:', err);
                });
              
              // Handle service worker updates
              function handleServiceWorkerUpdate() {
                // Check for updates when the page loads
                navigator.serviceWorker.ready.then(registration => {
                  registration.update().catch(err => {
                    console.error('Service worker update failed:', err);
                  });
                });
                
                // When a new service worker is waiting to be activated
                if (registration.waiting) {
                  console.log('New version available! Ready to update.');
                  // Notify the user about update
                  showUpdateNotification();
                }
                
                // When a new service worker is detected
                registration.addEventListener('updatefound', () => {
                  const newWorker = registration.installing;
                  if (!newWorker) return;
                  
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      console.log('New version installed! Ready to update.');
                      showUpdateNotification();
                    }
                  });
                });
              }
              
              handleServiceWorkerUpdate();
              
              // گوش دادن به پیام‌های سرویس ورکر
              navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                  console.log('Update available message received from SW:', event.data);
                  
                  // نمایش اعلان بروزرسانی فقط اگر نسخه جدید باشد
                  const storedVersion = localStorage.getItem('app_version') || '';
                  const newVersion = event.data.version;
                  
                  console.log('Comparing versions:', storedVersion, 'vs', newVersion);
                  
                  // نمایش اعلان بروزرسانی
                  showUpdateNotification();
                }
              });
            })
            .catch(function(err) {
              // Registration failed
              console.error('ServiceWorker registration failed: ', err);
              
              // پاکسازی کش سرویس ورکر در صورت خطا و تلاش مجدد
              navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                  registration.unregister();
                }
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              });
            });
            
          // Listen for controller change events
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            refreshing = true;
            console.log('Controller changed, refreshing page...');
            window.location.reload();
          });
        });
        
        // Check for updates every 15 minutes
        setInterval(() => {
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: 'CHECK_FOR_UPDATES'
            });
          }
        }, 15 * 60 * 1000);
        
        // Function to show update notification
        function showUpdateNotification() {
          // Simple notification implementation
          if (typeof window.showToast === 'function') {
            window.showToast({
              title: 'بروزرسانی جدید',
              description: 'نسخه جدید برنامه در دسترس است. برای اعمال تغییرات، صفحه را بروزرسانی کنید.',
              action: {
                label: 'بروزرسانی',
                onClick: () => {
                  if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                      type: 'SKIP_WAITING'
                    });
                  }
                }
              }
            });
          } else {
            if (confirm('نسخه جدید برنامه در دسترس است. می‌خواهید صفحه را بروزرسانی کنید؟')) {
              if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                  type: 'SKIP_WAITING'
                });
              }
            }
          }
        }
      }
    </script>
    <!-- دکمه پاکسازی کش برای مواقع ضروری -->
    <script>
      function addCacheClearButton() {
        // فقط در صفحه گزارش‌ها اضافه می‌کنیم
        if (window.location.pathname.includes('/Reports')) {
          setTimeout(() => {
            // اطمینان از لود شدن صفحه
            const header = document.querySelector('header');
            if (header && !document.getElementById('clear-cache-btn')) {
              const btn = document.createElement('button');
              btn.id = 'clear-cache-btn';
              btn.innerText = 'پاکسازی کش';
              btn.className = 'px-3 py-1 text-xs bg-red-500 text-white rounded-md ml-2';
              btn.onclick = () => {
                if (window.clearServiceWorkerCache) {
                  window.clearServiceWorkerCache();
                  alert('در حال پاکسازی کش و بارگذاری مجدد...');
                }
              };
              header.appendChild(btn);
            }
          }, 1000);
        }
      }
      
      // اجرای تابع بعد از لود شدن صفحه و هنگام تغییر مسیر
      window.addEventListener('load', addCacheClearButton);
      window.addEventListener('popstate', addCacheClearButton);
      
      // برای SPAها، یک Observer اضافه می‌کنیم
      const observer = new MutationObserver(addCacheClearButton);
      window.addEventListener('load', () => {
        const targetNode = document.body;
        if (targetNode) {
          observer.observe(targetNode, { childList: true, subtree: true });
        }
      });
    </script>
    <!-- Lovable required script -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <!-- Main app entry -->
    <script type="module" src="/src/main.tsx"></script>
    <noscript>برای استفاده از این برنامه، لطفا جاوااسکریپت مرورگر خود را فعال کنید.</noscript>
  </body>
</html>
